<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEST SENAT - Retirar Senha</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        .qr-border { border: 12px solid white; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="bg-slate-50 min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Card Principal -->
    <div class="w-full max-w-lg bg-white rounded-3xl shadow-2xl overflow-hidden">
        <!-- Header -->
        <div class="bg-blue-900 text-white p-8 text-center relative">
            <h2 class="text-3xl font-black uppercase tracking-tighter">Retire sua Senha</h2>
            <p class="text-blue-300 text-xs font-bold uppercase mt-1">Unidade SEST SENAT</p>
            
            <!-- Botão QR Code -->
            <button onclick="abrirModalQR()" class="absolute top-6 right-6 bg-white/10 hover:bg-white/20 p-2 rounded-xl">
                <i data-lucide="qr-code" class="w-6 h-6"></i>
            </button>
        </div>

        <!-- Formulário -->
        <div class="p-8 space-y-6">
            <div class="space-y-4">
                <div>
                    <label class="block text-slate-500 text-[10px] font-black uppercase mb-2">Nome Completo</label>
                    <input id="nome" type="text" placeholder="Digite seu nome" class="w-full px-5 py-4 rounded-2xl border-2 border-slate-100 focus:border-blue-600 outline-none bg-slate-50">
                </div>
                <div>
                    <label class="block text-slate-500 text-[10px] font-black uppercase mb-2">CPF</label>
                    <input id="cpf" type="text" placeholder="000.000.000-00" class="w-full px-5 py-4 rounded-2xl border-2 border-slate-100 focus:border-blue-600 outline-none bg-slate-50">
                </div>
                <div>
                    <label class="block text-slate-500 text-[10px] font-black uppercase mb-2">Serviço Desejado</label>
                    <select id="servico" class="w-full px-5 py-4 rounded-2xl border-2 border-slate-100 bg-slate-50 outline-none focus:border-blue-600 font-bold">
                        <option value="A">Primeira Habilitação</option>
                        <option value="B" selected>Renovação de CNH</option>
                        <option value="C">Segunda Via</option>
                        <option value="D">Serviços DETRAN</option>
                    </select>
                </div>
            </div>

            <button onclick="gerarSenha()" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-black py-5 rounded-2xl text-xl shadow-lg flex items-center justify-center gap-3">
                <i data-lucide="ticket" class="w-6 h-6"></i> EMITIR SENHA
            </button>
        </div>
    </div>

    <!-- Modal QR Code -->
    <div id="modalQR" class="fixed inset-0 bg-slate-900/90 hidden items-center justify-center p-6 z-50 backdrop-blur-md">
        <div class="bg-white p-8 rounded-[2.5rem] text-center max-w-sm w-full">
            <h3 class="text-2xl font-black text-slate-800 mb-4">Acesse pelo Celular</h3>
            <div class="qr-border inline-block rounded-3xl mb-8 bg-white">
                <div id="qrcode_canvas"></div>
            </div>
            <button onclick="fecharModalQR()" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold py-4 rounded-2xl">
                FECHAR
            </button>
        </div>
    </div>

    <!-- Modal de Confirmação -->
    <div id="modalSenha" class="fixed inset-0 bg-blue-900/95 hidden items-center justify-center p-6 z-50">
        <div class="bg-white p-10 rounded-[3rem] text-center max-w-sm w-full border-t-[12px] border-orange-500">
            <p class="text-slate-400 font-black uppercase tracking-[0.3em] text-xs mb-4">Sua Senha</p>
            <div id="senhaDisplay" class="text-8xl font-black text-blue-900 mb-8">---</div>
            <div class="bg-orange-100 text-orange-700 py-3 px-6 rounded-2xl font-bold inline-flex items-center gap-2">
                <i data-lucide="bell" class="w-4 h-4"></i> AGUARDE O PAINEL
            </div>
        </div>
    </div>

    <script>
        // Inicializa ícones
        lucide.createIcons();

        // ========== FUNÇÕES DO QR CODE ==========
        function abrirModalQR() {
            const modal = document.getElementById('modalQR');
            const qrContainer = document.getElementById('qrcode_canvas');
            
            qrContainer.innerHTML = "";
            
            // Pega a URL atual (a mesma página)
            const urlAtual = window.location.href;
            
            new QRCode(qrContainer, {
                text: urlAtual,
                width: 220,
                height: 220,
                colorDark: "#1e3a8a",
                colorLight: "#ffffff"
            });
            
            modal.classList.remove('hidden');
        }

        function fecharModalQR() {
            document.getElementById('modalQR').classList.add('hidden');
        }

        // ========== FUNÇÃO PRINCIPAL ==========
        function gerarSenha() {
            const nomeInput = document.getElementById('nome');
            const cpfInput = document.getElementById('cpf');
            
            // Validação
            if(!nomeInput.value.trim()) {
                alert("Por favor, digite seu nome.");
                return;
            }

            // Gera a senha
            let contador = parseInt(localStorage.getItem("sest_contador") || "0") + 1;
            let prefixo = document.getElementById('servico').value;
            let senha = prefixo + String(contador).padStart(3, '0');
            let sala = Math.random() < 0.5 ? "SALA 1" : "SALA 2";
            let timestamp = Date.now();
            let horaAtual = new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});

            // Salva no localStorage do TOTEM
            localStorage.setItem("sest_contador", contador);
            localStorage.setItem("sest_ultima_senha", senha);
            localStorage.setItem("sest_ultima_sala", sala);
            localStorage.setItem("sest_timestamp", timestamp);

            // Histórico local
            let historico = JSON.parse(localStorage.getItem("sest_historico") || "[]");
            historico.unshift({ 
                nome: nomeInput.value.trim(), 
                cpf: cpfInput.value.trim() || "000.000.000-00",
                senha: senha, 
                sala: sala, 
                hora: horaAtual
            });
            localStorage.setItem("sest_historico", JSON.stringify(historico.slice(0, 10)));

            // ===== ENVIA PARA O PAINEL =====
            // SUBSTITUA 'SEUUSUARIO' pelo seu nome do GitHub
            const urlGestao = `https://isaacfirmino.github.io/sest-senat-gestao/Painel%20digital.html?senha=${senha}&nome=${encodeURIComponent(nomeInput.value.trim())}&sala=${sala}&timestamp=${timestamp}`;
            
            console.log("Abrindo URL do painel:", urlGestao);
            
            // Tenta abrir em uma nova aba (funciona no celular se não bloquear)
            window.open(urlGestao, '_blank');

            // Mostra modal de sucesso
            document.getElementById('senhaDisplay').innerText = senha;
            document.getElementById('modalSenha').classList.remove('hidden');

            // Limpa formulário após 4 segundos
            setTimeout(() => {
                document.getElementById('modalSenha').classList.add('hidden');
                nomeInput.value = "";
                cpfInput.value = "";
            }, 4000);
        }
    </script>
</body>
</html>
